<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heure actuelle et Code TOTP</title>
  <style>
    #currentTime {
      font-size: 2em;
      font-family: Arial, sans-serif;
    }
    #totpCode {
      font-size: 2em;
      font-family: Arial, sans-serif;
      color: #007BFF;
    }
  </style>
</head>
<body>

<h2>Heure actuelle</h2>
<div id="currentTime">Loading...</div>

<h2>Code TOTP généré</h2>
<div id="totpCode">---</div>

<script>
  // Fonction pour formater l'heure en "HH:mm:ss"
  function formatTime(date) {
    let hours = date.getHours().toString().padStart(2, '0');
    let minutes = date.getMinutes().toString().padStart(2, '0');
    let seconds = date.getSeconds().toString().padStart(2, '0');
    return `${hours}:${minutes}:${seconds}`;
  }

  // Fonction pour convertir une chaîne Base32 en binaire
  function base32ToBytes(base32) {
    const base32Chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
    const byteArray = [];
    let buffer = 0;
    let bitsLeft = 0;

    for (let i = 0; i < base32.length; i++) {
      const char = base32[i];
      const value = base32Chars.indexOf(char.toUpperCase());

      if (value === -1) continue;

      buffer = (buffer << 5) | value;
      bitsLeft += 5;

      if (bitsLeft >= 8) {
        byteArray.push((buffer >> (bitsLeft - 8)) & 0xFF);
        bitsLeft -= 8;
      }
    }

    return byteArray;
  }

  // Fonction pour effectuer le calcul HMAC-SHA1
  function hmacSHA1(key, message) {
    const crypto = window.crypto || window.msCrypto;  // Crypto API
    const enc = new TextEncoder();
    const keyData = enc.encode(key);
    const messageData = enc.encode(message);

    return crypto.subtle.importKey(
      'raw', 
      keyData, 
      { name: 'HMAC', hash: { name: 'SHA-1' } }, 
      false, 
      ['sign']
    ).then(function(key) {
      return crypto.subtle.sign('HMAC', key, messageData);
    }).then(function(signature) {
      const dataView = new DataView(signature);
      let hex = '';
      for (let i = 0; i < signature.byteLength; i++) {
        hex += ('00' + dataView.getUint8(i).toString(16)).slice(-2);
      }
      return hex;
    });
  }

  // Fonction pour générer un code TOTP en tenant compte de l'heure du système
  function generateTOTP() {
    const secretBase32 = 'JBSWY3DPEHPK3PXP'; // Exemple de secret en Base32
    const secretBytes = base32ToBytes(secretBase32); // Convertir le secret en binaire

    const epoch = Math.floor(Date.now() / 1000); // Heure actuelle en secondes
    const time = Math.floor(epoch / 30); // Diviser par 30 pour obtenir l'intervalle de 30 secondes
    const timeBuffer = new ArrayBuffer(8);
    const view = new DataView(timeBuffer);
    view.setUint32(0, Math.floor(time / Math.pow(2, 32))); // Partie haute du temps
    view.setUint32(4, time & 0xFFFFFFFF); // Partie basse du temps

    // Calcul du HMAC-SHA1
    hmacSHA1(secretBytes, timeBuffer).then(function(signatureHex) {
      // Troncature dynamique : récupérer les 4 derniers bits pour déterminer la position de départ
      const offset = parseInt(signatureHex.slice(-1), 16);
      const code = parseInt(signatureHex.slice(offset * 2, (offset + 4) * 2), 16) & 0x7FFFFFFF; // Masquer les bits de signe
      const otp = code % 1000000; // Code à 6 chiffres
      const totpCode = otp.toString().padStart(6, '0'); // Formater en 6 chiffres

      document.getElementById('totpCode').textContent = totpCode; // Afficher le code TOTP
    });
  }

  // Fonction pour mettre à jour l'heure et le TOTP
  function updateTimeAndTOTP() {
    const currentDate = new Date();  // Obtenir la date et l'heure actuelles
    const timeString = formatTime(currentDate);  // Formater l'heure
    document.getElementById('currentTime').textContent = timeString;  // Afficher l'heure

    generateTOTP();  // Mettre à jour le code TOTP
  }

  // Mettre à jour l'heure et le code TOTP toutes les secondes
  setInterval(updateTimeAndTOTP, 1000);

  // Initialiser l'heure et le TOTP dès le chargement de la page
  updateTimeAndTOTP();
</script>

</body>
</html>
